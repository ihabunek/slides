<!DOCTYPE html>
<html>
<head>
    <title>Travis CI - Ivan Habunek</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">

        @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
        @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
        @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

        body { font-family: 'Droid Serif', Helvetica, Arial, sans-serif }
        h1, h2, h3, h4, h5 {
            font-family: 'Yanone Kaffeesatz', Helvetica, Arial, sans-serif;
            font-weight: normal;
        }
        td {
            padding: 4px 10px;
        }
        .remark-code, .remark-inline-code {
            font-family: 'Ubuntu Mono', Consolas, Courier new, monospace;
        }
        .remark-code {
            font-size: 26px;
        }
        .code16 {
            font-size: 16px;
        }
        .code20 {
            font-size: 20px;
        }
        .remark-slide-content {
            font-size: 24px;
        }
        .remark-notes, .remark-notes-preview {
            font-size: 28px;
        }
        blockquote {
            text-align: justify;
        }
    </style>
</head>
<body>
    <textarea id="source">

class: center, middle

![Travis CI](images/travis-logo.png)

## Testing open source projects

## Ivan Habunek

PHP T-Day, Belgrade, 22.11.2014

---

class: center, middle

## Ivan Habunek

### @ihabunek

***Big Fish Software*** Developer and owner

***WebCamp Zagreb*** Co-organizer

***ZgPHP meetups*** Co-organizer

***Apache Software Foundation*** Commiter and PMC member

Open source enthusiast

---

## The code

```sh
/src/Random.php
```

```php
class Random
{
    public function getRandomNumber()
    {
        // Choosen by a fair dice roll.
        // Guaranteed to be random.
        return 4;
    }
}
```

Source: `http://xkcd.com/221/`

???

- minimalan primjer
- nedostaje napespace

---

## The test

```sh
/tests/RandomTest.php
```

```php
class RandomTest extends PHPUnit_Framework_TestCase
{
    public function testGetRandomNumber()
    {
        $random = new Random();
        $actual = $random->getRandomNumber();
        $this->assertSame(4, $actual);
    }
}
```

???

- Test Driven Development afficionados do it the other way around

---

## Run phpunit

```sh
> phpunit
```

```sh
PHPUnit 3.7.21 by Sebastian Bergmann.

Configuration read from phpunit.xml

.

Time: 0 seconds, Memory: 2.75Mb

OK (1 test, 1 assertion)
```

???

---

## Good enough?

--

* Well, maybe...

--

* If you're self-disciplined

--

* If you work on a project alone

--

* If your environment is identical to production

???

If the build passes on your computer, will it work on production?

--

* If you support only one version of PHP

--

* If you support only one database

--

* Maybe not

---

## Continuous Integration

> Continuous Integration is a software development practice where members of a
> team integrate their work frequently, usually each person integrates at least
> daily, leading to multiple integrations per day. Each integration is verified
> by an automated build (including test) to detect integration errors as quickly
> as possible.

Martin Fowler (2006)

`http://www.martinfowler.com/articles/continuousIntegration.html`

???

* integration is a merge to a central branch (e.g. develop)
* integrate often
* run automated tests
* early error detection

- early detection of errors => early fixing of errors
- contrast to doing long arduous merges after implementing a huge feature

---

background-image: url(images/octocat.jpg)

---

class: center

![Travis CI](images/travis-logo.png)

## A hosted continuous integration service for the open source community

???

* Runs your tests every time you push code to GitHub

---

class: center

![Travis CI](images/travis-logo.png)

## Supported runtimes

Android&nbsp;&nbsp;&nbsp;&nbsp;
C&nbsp;&nbsp;&nbsp;&nbsp;
C++&nbsp;&nbsp;&nbsp;&nbsp;
Clojure&nbsp;&nbsp;&nbsp;&nbsp;
Erlang&nbsp;&nbsp;&nbsp;&nbsp;
Go&nbsp;&nbsp;&nbsp;&nbsp;
Groovy&nbsp;&nbsp;&nbsp;&nbsp;

Haskell&nbsp;&nbsp;&nbsp;&nbsp;
Java&nbsp;&nbsp;&nbsp;&nbsp;
JavaScript&nbsp;&nbsp;&nbsp;&nbsp;
Node.js&nbsp;&nbsp;&nbsp;&nbsp;
Objective-C&nbsp;&nbsp;&nbsp;&nbsp;

Perl&nbsp;&nbsp;&nbsp;&nbsp;
**PHP**&nbsp;&nbsp;&nbsp;&nbsp;
Python&nbsp;&nbsp;&nbsp;&nbsp;
Ruby&nbsp;&nbsp;&nbsp;&nbsp;
Scala&nbsp;&nbsp;&nbsp;&nbsp;

---

class: center

![Travis CI](images/travis-logo.png)

## Preinstalled services

MySQL&nbsp;&nbsp;&nbsp;
PostgreSQL&nbsp;&nbsp;&nbsp;
MongoDB&nbsp;&nbsp;&nbsp;
CouchDB&nbsp;&nbsp;&nbsp;
Redis&nbsp;&nbsp;&nbsp;

Riak&nbsp;&nbsp;&nbsp;
RabbitMQ&nbsp;&nbsp;&nbsp;
Memcached&nbsp;&nbsp;&nbsp;
Cassandra&nbsp;&nbsp;&nbsp;

Neo4J&nbsp;&nbsp;&nbsp;
ElasticSearch&nbsp;&nbsp;&nbsp;
Kestrel&nbsp;&nbsp;&nbsp;
SQLite3&nbsp;&nbsp;&nbsp;

---

## Setup

1. Login via GitHub
2. Service hook
3. `.travis.yml`
4. Push

---

background-image: url(images/permissions.png)

---

background-image: url(images/travis-hook.gif)

---

## .travis.yml

```sh
language: php
```

---

## Push!

```sh
> git push
```

```sh
Counting objects: 10, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (7/7), done.
Writing objects: 100% (7/7), 777 bytes, done.
Total 7 (delta 3), reused 0 (delta 0)
To https://github.com/ihabunek/travis-demo.git
   8bf4a4d..2cb23eb  master -> master
```

---

background-image: url(images/single-build.png)

---

background-image: url(images/build-history.png)

???

* Keeps history of all your failures

---

class: center, middle

# Configuration

---

`.travis.yml`

```sh
language: php
```

???

Let's talk a little about configuration.

This is a basic configuration.

---

`.travis.yml`

```sh
language: php

php: 5.5

script: phpunit
```

???

Travis has sensible defaults

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm
```

???

* Runs tests once for every version specified

---

background-image: url(images/build-versions.png)

---

# Scripts

&nbsp;                |  &nbsp;
--------------- | ------------------------------------
`install`       | Installs dependencies
`before_script` | Sets up build
`script`        | Runs the tests
`after_success` | Runs if build was successful
`after_failure` | Runs if build failed
`after`         | Runs after build always

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

script: phpunit
```

???

Use the 'script' parameter to tell Travis how to run your test suite.

It holds one or more bash commands.

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

script: phpunit --coverage-html target/coverage
```

???

You can change it to customize phpunit options.

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

script: vendor/bin/atoum
```

???

To run other test frameworks.

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

script: ./bin/test.sh
```

???

Or to run your custom test runner script.

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm
```

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

install: composer install
```

???

If you use Composer (and you do), use the "install" setting to install your
dependencies.


---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

install:
    - composer install
    - pecl install oauth
```

???

Also use it to install any other extensions and prerequisites which are not
available by default on Travis.

---

`.travis.yml`


```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

install:
    - composer install
    - pecl install oauth
    - apt-get -y install solr
```

---

`.travis.yml`

```sh
language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm

env:
    - DB=postgres
    - DB=mysql
    - DB=sqlite

script: phpunit --configuration $DB.phpunit.xml
```

???

- Integration tests.
- Sets environment variables.

---

background-image: url(images/build-matrix.png)

---


`.travis.yml`

```yml
notifications:
    email:
        - ivan.habunek@gmail.com
        - ivan@bezdomni.net
```

---


`.travis.yml`

```yml
notifications:
    irc:
        - "irc.freenode.org#zgphp"
```

--

![IRC notification](images/notify-irc.png)

---

background-image: url(images/what-year.jpg)

---


`.travis.yml`

```yml
notifications:
    campfire: [subdomain]:[api_token]@[room]
    flowdock: [api_token]
    hipchat:  [api_token]@[room]
    sqwiggle: [api_token]@[room]
    slack:    [account]:[token]#[channel]
```

---

`.travis.yml`

```yml
notifications:
    webhooks:
        urls:
            - "http://bezdomni.net/hooks/travis"
```

---

```sh
POST /hooks/travis
```

```code16
{
    "id": 11127910,
    "repository": {
        "id": 1220417,
        "name": "travis-demo",
        "owner_name": "ihabunek",
        "url": "https:\/\/github.com\/ihabunek\/travis-demo"
    },
    "number": "25",
    "config": {
        "language": "php",
        "php": [
            5.3,
            5.4,
            5.5
        ],
        "before_script": [
            "composer self-update",
            "composer install"
        ],
        "notifications": {
            "webhooks": {
                "urls": [
                    "http:\/\/bezdomni.net\/travis.php"
                ],
                "on_success": "always",
                "on_failure": "always",
                "on_start": true
            },
            "irc": [
                "chat.freenode.net#zgphp"
            ]
        },
        ".result": "configured"
    },
    "status": 1,
    "result": 1,
    "status_message": "Pending",
    "result_message": "Pending",
    "started_at": "2013-09-08T18:25:28Z",
    "finished_at": null,
    "duration": null,
    "build_url": "https:\/\/travis-ci.org\/ihabunek\/travis-demo\/builds\/11127910",
    "commit": "fb757c43a96f6cf8886d612943da57a9c06a616c",
    "branch": "master",
    "message": "Testing IRC notifications",
    "compare_url": "https:\/\/github.com\/ihabunek\/travis-demo\/compare\/59cfd34c860a...fb757c43a96f",
    "committed_at": "2013-09-08T18:24:57Z",
    "author_name": "Ivan Habunek",
    "author_email": "ivan.habunek@gmail.com",
    "committer_name": "Ivan Habunek",
    "committer_email": "ivan.habunek@gmail.com"
}
```

---

class: center, middle

# Pull requests

???

Open source projects are all about accepting contributions.

Code review is good.

But tests help too.

---

background-image: url(images/pull-detemining-status.png)

---

background-image: url(images/pull-failed.png)

---

background-image: url(images/pull-success.png)

---

Great success.

???

TODO: borat?

---

class: center middle

# API

???

Standard REST + JSON

---

```sh
GET /repos/ihabunek/travis-demo
```

```code16
{
  "id": 1220417,
  "slug": "ihabunek/travis-demo",
  "description": "Travis demo",
  "public_key": "-----BEGIN RSA PUBLIC KEY-----\n...",
  "last_build_id": 39745461,
  "last_build_number": "31",
  "last_build_status": 0,
  "last_build_result": 0,
  "last_build_duration": 20,
  "last_build_language": null,
  "last_build_started_at": "2014-11-02T13:04:47Z",
  "last_build_finished_at": "2014-11-02T13:05:22Z"
}
```

---

```sh
GET /repos/ihabunek/travis-demo/builds
```

```code16
[
  {
    "id": 39745461,
    "repository_id": 1220417,
    "number": "31",
    "state": "finished",
    "result": 0,
    "started_at": "2014-11-02T13:04:47Z",
    "finished_at": "2014-11-02T13:05:22Z",
    "duration": 20,
    "commit": "b27189f256ea5da81feadc5727be63c410668bf4",
    "branch": "master",
    "message": "Test multiple version",
    "event_type": "push"
  },
  {
    "id": 39742247,
    "repository_id": 1220417,
    "number": "30",
    "state": "finished",
    "result": 0,
    "started_at": "2014-11-02T12:08:04Z",
    "finished_at": "2014-11-02T12:08:10Z",
    "duration": 6,
    "commit": "424e9f6ab3822776ba6815b31fdd690577fbd5bc",
    "branch": "master",
    "message": "Test no version",
    "event_type": "push"
  },
  ...
]
```

---

```sh
GET /repos/ihabunek/travis-demo/builds/39745461
```

```code16
{
  "id": 39745461,
  "repository_id": 1220417,
  "number": "31",
  "config": {
    "language": "php",
    "php": [
      5.4,
      5.5,
      5.6,
      "hhvm"
    ],
    ".result": "configured",
    "os": "linux"
  },
  "state": "finished",
  "result": 0,
  "status": 0,
  "started_at": "2014-11-02T13:04:47Z",
  "finished_at": "2014-11-02T13:05:22Z",
  "duration": 20,
  "commit": "b27189f256ea5da81feadc5727be63c410668bf4",
  "branch": "master",
  "message": "Test multiple version",
  "committed_at": "2014-11-02T13:04:12Z",
  "author_name": "Ivan Habunek",
  "author_email": "ivan.habunek@gmail.com",
  "committer_name": "Ivan Habunek",
  "committer_email": "ivan.habunek@gmail.com",
  "compare_url": "https://github.com/ihabunek/travis-demo/compare/424e9f6ab382...b27189f256ea",
  "event_type": "push",
  "matrix": [
  ...`
```

---

class: center middle

# CLI

---

```sh
> gem install travis
```

---

```sh
> travis help
```

```code20
Available commands:

accounts  displays accounts and their subscription status
branches  displays the most recent build for each branch
cancel    cancels a job or build
console   interactive shell
disable   disables a project
enable    enables a project
encrypt   encrypts values for the .travis.yml
endpoint  displays or changes the API endpoint
help      helps you out when in dire need of information
history   displays a projects build history
init      generates a .travis.yml and enables the project
login     authenticates against the API and stores the token
logs      streams test logs
monitor   live monitor for what's going on
open      opens a build or job in the browser
pubkey    prints out a repository's public key
raw       makes an (authenticated) API call and prints out the result
restart   restarts a build or job
setup     sets up an addon or deploy target
show      displays a build or job
status    checks status of the latest build
sync      triggers a new sync with GitHub
token     outputs the secret API token
version   outputs the client version
whatsup   lists most recent builds
whoami    outputs the current user
```

---

```sh
> travis history
```

```code20
#25 passed:     master Testing IRC notifications
#21 passed:     master Testing notifications
#20 passed:     master Removed testing on 5.2
#19 errored:    master Added 'composer install' to travis.yml
#18 passed:     master Added dependency on symfony/console
#17 passed:     master Merge pull request #3 from ihabunek/correctamondo
#16 passed:     Pull Request #3 Added a nod to XKCD
```

---

```none
> travis show 25
```

```none
Build #25: Testing IRC notifications
State:         passed
Type:          push
Branch:        master
Compare URL:   https://github.com/ihabunek/travis-demo/compare/59cfd34c860a...fb757c43a96f
Duration:      1 min 8 sec
Started:       2013-09-08 20:25:28
Finished:      2013-09-08 20:26:03

#25.1 passed:    26 sec         php: 5.3
#25.2 passed:    18 sec         php: 5.4
#25.3 passed:    24 sec         php: 5.5
```

---

## PHP Travis Client

`https://github.com/l3l0/php-travis-client`

```php
$client = new Travis\Client();
$repo = $client->fetchRepository('ihabunek/travis-demo');

echo "Builds:\n";
foreach ($repo->getBuilds() as $build) {
    $id = $build->getID();
    $result = $build->getResult() ? "Passed" : "Failed";
    echo " - $id: $result\n";
}
```

---

class: center, middle

## Questions?

Please rate my talk

![Rate my talk](images/qrcode.png)

`https://joind.in/12413`

## References

* Borat meme: `http://www.quickmeme.com/meme/3sufea`

    </textarea>

    <script src="http://gnab.github.io/remark/downloads/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
</body>
</html>
